- name: Secure Moodle deploy
  hosts: localhost
  become: true
  vars:
    ansible_user: "{{ lookup('env','USER') }}"
    moodle_version: "5.1"
  pre_tasks:
    - name: Check if password directory exists
      delegate_to: localhost
      become: false
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/.ansible_passwords"
      register: password_dir_stat
      ignore_errors: true

    - name: Remove password directory only if it has wrong ownership
      delegate_to: localhost
      become: true
      ansible.builtin.command:
        cmd: rm -rf {{ playbook_dir }}/.ansible_passwords
      when:
        - password_dir_stat.stat.exists
        - password_dir_stat.stat.pw_name is defined
        - password_dir_stat.stat.pw_name == 'root'
      changed_when: true

    - name: Ensure password directory exists as current user
      delegate_to: localhost
      become: false
      ansible.builtin.file:
        path: "{{ playbook_dir }}/.ansible_passwords"
        state: directory
        mode: "0700"
  roles:
    - secure_moodle
