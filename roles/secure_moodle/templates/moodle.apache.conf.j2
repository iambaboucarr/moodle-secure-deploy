# Security headers applied to this vhost
<IfModule mod_headers.c>
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

<Directory {{ moodle_deploy_destination }}>
  Options -Indexes
  AllowOverride None
  RewriteEngine On

{% for file in moodle_web_protected_files %}
  RewriteCond %{REQUEST_URI} {{ file }}$
  RewriteRule ^.*$ - [R=404]
{% endfor %}

{% for directory in moodle_web_protected_directories %}
  RewriteCond %{REQUEST_URI} ^/{{ moodle_web_path | replace(".", "\.") }}(?:[^/]*/)*/?{{ directory }}
  RewriteRule ^.*$ - [R=404]
{% endfor %}

  <FilesMatch \.php$>
    SetHandler "proxy:unix:/run/php/php{{ (php_version | default(secure_moodle_php_version)) }}-fpm.sock|fcgi://localhost/"
  </FilesMatch>
</Directory>
